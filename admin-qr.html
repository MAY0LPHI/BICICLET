<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - QR Code - BICICLET</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="libs/tailwind.min.js"></script>
    <script src="libs/lucide.js"></script>
    <style>
        .dark body {
            background-color: #1a202c;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üö≤ Painel Administrativo - QR Code</h1>
                    <p class="text-gray-600">Gerencie solicita√ß√µes e visualize registros</p>
                </div>
                <a href="/" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Voltar ao Sistema
                </a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <button id="tabSolicitacoes" class="flex-1 py-4 px-6 text-center font-semibold border-b-2 border-blue-500 text-blue-500">
                    Solicita√ß√µes Pendentes
                </button>
                <button id="tabRegistros" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-gray-700">
                    Registros QR
                </button>
                <button id="tabQRCodes" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-gray-700">
                    Gerar QR Codes
                </button>
            </div>
        </div>

        <!-- Solicita√ß√µes Pendentes -->
        <div id="contentSolicitacoes" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-4">Solicita√ß√µes de Cadastro Pendentes</h2>
            <div id="listaSolicitacoes">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
        </div>

        <!-- Registros QR -->
        <div id="contentRegistros" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Registros de Entrada/Sa√≠da via QR</h2>
            <div class="mb-4">
                <button id="btnRefreshRegistros" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Atualizar
                </button>
            </div>
            <div id="listaRegistros">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
        </div>

        <!-- Gerar QR Codes -->
        <div id="contentQRCodes" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Gerar QR Codes para Esta√ß√µes</h2>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="stationId">
                    ID da Esta√ß√£o
                </label>
                <div class="flex gap-2">
                    <input class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline flex-1" 
                           id="stationId" type="text" placeholder="Ex: estacao1" value="default">
                    <button id="btnGenerateQR" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Gerar QR Code
                    </button>
                </div>
            </div>
            <div id="qrDisplay" class="text-center"></div>
            <div class="mt-6 p-4 bg-blue-50 rounded">
                <p class="text-sm text-gray-700">
                    <strong>Instru√ß√µes:</strong> Gere um QR code para cada esta√ß√£o/terminal do biciclet√°rio. 
                    Os usu√°rios podem escanear este QR code para acessar a tela de login/cadastro.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        const tabs = {
            solicitacoes: {
                btn: document.getElementById('tabSolicitacoes'),
                content: document.getElementById('contentSolicitacoes')
            },
            registros: {
                btn: document.getElementById('tabRegistros'),
                content: document.getElementById('contentRegistros')
            },
            qrcodes: {
                btn: document.getElementById('tabQRCodes'),
                content: document.getElementById('contentQRCodes')
            }
        };

        function switchTab(tabName) {
            Object.entries(tabs).forEach(([name, tab]) => {
                if (name === tabName) {
                    tab.btn.classList.add('border-blue-500', 'text-blue-500');
                    tab.btn.classList.remove('text-gray-500');
                    tab.content.classList.remove('hidden');
                } else {
                    tab.btn.classList.remove('border-blue-500', 'text-blue-500');
                    tab.btn.classList.add('text-gray-500');
                    tab.content.classList.add('hidden');
                }
            });
        }

        tabs.solicitacoes.btn.addEventListener('click', () => switchTab('solicitacoes'));
        tabs.registros.btn.addEventListener('click', () => switchTab('registros'));
        tabs.qrcodes.btn.addEventListener('click', () => switchTab('qrcodes'));

        // Load pending requests
        async function loadSolicitacoes() {
            const lista = document.getElementById('listaSolicitacoes');
            
            try {
                const response = await fetch('/api/qr/solicitacoes');
                const solicitacoes = await response.json();
                
                if (!solicitacoes || solicitacoes.length === 0) {
                    lista.innerHTML = '<p class="text-gray-500">Nenhuma solicita√ß√£o pendente.</p>';
                    return;
                }

                lista.innerHTML = solicitacoes.map(s => `
                    <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${s.nome}</h3>
                                <p class="text-gray-600">CPF: ${formatCPF(s.cpf)}</p>
                                <p class="text-gray-600">Email: ${s.email}</p>
                                <p class="text-gray-600">Telefone: ${s.telefone || 'N√£o informado'}</p>
                                <p class="text-sm text-gray-500 mt-2">
                                    Esta√ß√£o: ${s.station_id || 'default'} | 
                                    Solicitado em: ${new Date(s.criado_em).toLocaleString('pt-BR')}
                                </p>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick="aprovarSolicitacao('${s.id}')" 
                                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                                    Aprovar
                                </button>
                                <button onclick="rejeitarSolicitacao('${s.id}')" 
                                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                    Rejeitar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                lista.innerHTML = '<p class="text-red-500">Erro ao carregar solicita√ß√µes.</p>';
            }
        }

        // Load QR registros
        async function loadRegistros() {
            const lista = document.getElementById('listaRegistros');
            
            try {
                const response = await fetch('/api/qr/registros');
                const registros = await response.json();
                
                if (!registros || registros.length === 0) {
                    lista.innerHTML = '<p class="text-gray-500">Nenhum registro encontrado.</p>';
                    return;
                }

                // Create table
                lista.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">Tipo</th>
                                    <th class="px-4 py-2 text-left">Cliente</th>
                                    <th class="px-4 py-2 text-left">Bicicleta</th>
                                    <th class="px-4 py-2 text-left">Data/Hora</th>
                                    <th class="px-4 py-2 text-left">Esta√ß√£o</th>
                                    <th class="px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registros.map(r => `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-4 py-2">
                                            <span class="inline-block px-2 py-1 rounded ${r.tipo === 'entrada' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                                ${r.tipo === 'entrada' ? 'üì• Entrada' : 'üì§ Sa√≠da'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-2">${r.cliente_id}</td>
                                        <td class="px-4 py-2">${r.bicicleta_descricao || '-'}</td>
                                        <td class="px-4 py-2">${new Date(r.data_hora).toLocaleString('pt-BR')}</td>
                                        <td class="px-4 py-2">${r.station_id || 'default'}</td>
                                        <td class="px-4 py-2">
                                            <span class="inline-block px-2 py-1 rounded ${r.status === 'ativo' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                                ${r.status}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                lista.innerHTML = '<p class="text-red-500">Erro ao carregar registros.</p>';
            }
        }

        // Approve request
        async function aprovarSolicitacao(id) {
            if (!confirm('Aprovar esta solicita√ß√£o de cadastro?')) return;
            
            try {
                const response = await fetch('/api/qr/solicitacao/aprovar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, aprovado_por: 'admin' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Solicita√ß√£o aprovada com sucesso!');
                    loadSolicitacoes();
                } else {
                    alert('Erro ao aprovar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro de conex√£o ao aprovar solicita√ß√£o');
            }
        }

        // Reject request
        async function rejeitarSolicitacao(id) {
            const observacoes = prompt('Motivo da rejei√ß√£o (opcional):');
            if (observacoes === null) return; // User cancelled
            
            try {
                const response = await fetch('/api/qr/solicitacao/rejeitar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, aprovado_por: 'admin', observacoes })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Solicita√ß√£o rejeitada');
                    loadSolicitacoes();
                } else {
                    alert('Erro ao rejeitar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro de conex√£o ao rejeitar solicita√ß√£o');
            }
        }

        // Generate QR Code
        document.getElementById('btnGenerateQR').addEventListener('click', async () => {
            const stationId = document.getElementById('stationId').value || 'default';
            const qrDisplay = document.getElementById('qrDisplay');
            
            qrDisplay.innerHTML = '<div class="animate-pulse"><div class="h-64 w-64 bg-gray-200 rounded mx-auto"></div></div>';
            
            try {
                const response = await fetch(`/api/qr/generate?station=${stationId}`);
                const data = await response.json();
                
                if (data.success && data.qr_code) {
                    qrDisplay.innerHTML = `
                        <div>
                            <img src="${data.qr_code}" alt="QR Code" class="mx-auto w-64 h-64 border-4 border-gray-300 rounded-lg shadow-lg mb-4">
                            <p class="text-gray-600">Esta√ß√£o: <strong>${stationId}</strong></p>
                            <a href="${data.qr_code}" download="qrcode_${stationId}.png" 
                               class="inline-block mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                Baixar QR Code
                            </a>
                            <a href="/qrcode.html?station=${stationId}" target="_blank"
                               class="inline-block mt-4 ml-2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                                Abrir Tela de QR Code
                            </a>
                        </div>
                    `;
                } else {
                    qrDisplay.innerHTML = '<p class="text-red-500">Erro ao gerar QR Code</p>';
                }
            } catch (error) {
                qrDisplay.innerHTML = '<p class="text-red-500">Erro de conex√£o</p>';
            }
        });

        document.getElementById('btnRefreshRegistros').addEventListener('click', loadRegistros);

        // Helper function to format CPF
        function formatCPF(cpf) {
            if (!cpf) return '';
            cpf = cpf.replace(/\D/g, '');
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        // Load initial data
        loadSolicitacoes();
        
        // Auto refresh every 30 seconds
        setInterval(() => {
            if (!tabs.solicitacoes.content.classList.contains('hidden')) {
                loadSolicitacoes();
            } else if (!tabs.registros.content.classList.contains('hidden')) {
                loadRegistros();
            }
        }, 30000);
    </script>
</body>
</html>
